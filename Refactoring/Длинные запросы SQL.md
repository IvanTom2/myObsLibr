Запрос считается длинным, если селективность запроса высока по крайней мере для одной из больших таблицы. То есть результат, даже если он невелик, определяется почти всеми строками. 

Стратегии оптимизации:
1. Избегать многократных сканирований таблиц
2. Уменьшать размер результата на как можно более ранней стадии 

В длинных запросах выполняется последовательное сканирование. Последовательное сканирование хорошо работает с соединение хешированием. Соединение хешированием лучше всего работает, когда первый аргумент помещается в оперативную память. 

В некоторых случаях используется алгоритм соединения слиянием. Соединение слиянием может быть более эффективным, если ходят бы одна из таблиц предварительно отсортирована. Если выбираются уникальные значения, фактически выполняется сортировка. 

Наиболее ограничительные соединение (т.е. соединения, которые сильнее всего уменьшают количество результирующих строк) должны выполняться первыми. Часто наиболее ограничительным соединением является полусоединение. 

Полусоединение двух таблиц R и S возвращает строки из таблицы R, для которых есть хотя бы одна строка из таблицы S с совпадающими значениями в соединяемых столбах. Во-первых, при полусоединении в результирующем множестве появляются столбцы только из первой таблицы. Во-вторых, строки из первой таблицы не дублируются, если во второй таблице для них есть несколько соответствий. Чаще всего они даже не используются JOIN, а например WHERE EXISTS - posgtres в этом случае гарантирует исполнение Semi Join в плане выполнения. 

Антисоединение - это как полусоединение, только возвращаются строки, которых не существует во второй таблице. WHERE NOT EXISTS или NOT IN. 

Если количество таблиц в соединении становится достаточно большим (по умолчанию 8), то оптимизатор перестает искать лучший порядок соединений и выполняет их в том порядке, в котором они написаны. Также можно установить принудительный порядок соединений - через параметр SET join_collapse_limit = 1 (дефолт 8). 
___
Links: [[SQL]]
Tags: #sql 
References: [[Оптимизация запросов PostgreSQL]]